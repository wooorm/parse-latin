import fs from 'node:fs'
import path from 'node:path'
import regenerate from 'regenerate'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import N from '@unicode/unicode-13.0.0/General_Category/Number/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import L from '@unicode/unicode-13.0.0/General_Category/Letter/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Ll from '@unicode/unicode-13.0.0/General_Category/Lowercase_Letter/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import M from '@unicode/unicode-13.0.0/General_Category/Mark/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Pc from '@unicode/unicode-13.0.0/General_Category/Connector_Punctuation/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Pd from '@unicode/unicode-13.0.0/General_Category/Dash_Punctuation/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Pe from '@unicode/unicode-13.0.0/General_Category/Close_Punctuation/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Pf from '@unicode/unicode-13.0.0/General_Category/Final_Punctuation/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Pi from '@unicode/unicode-13.0.0/General_Category/Initial_Punctuation/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Po from '@unicode/unicode-13.0.0/General_Category/Other_Punctuation/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import Ps from '@unicode/unicode-13.0.0/General_Category/Open_Punctuation/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import BPWhiteSpace from '@unicode/unicode-13.0.0/Binary_Property/White_Space/code-points.js'
/** @type {{default: Array<number>}} */
// @ts-expect-error
import combiningDiacriticalMarks from '@unicode/unicode-13.0.0/Block/Combining_Diacritical_Marks/code-points.js'

const combiningDiacriticalMark = regenerate().add(combiningDiacriticalMarks)

const combiningNonspacingMark = regenerate().add(M)

const letter = regenerate().add(L)

const letterLower = regenerate().add(Ll)

const numerical = regenerate().add(N)

const punctuation = regenerate()
  .add(Pc)
  .add(Pd)
  .add(Pe)
  .add(Pf)
  .add(Pi)
  .add(Po)
  .add(Ps)

  // Remove few weirdly-classified symbols:
  // <https://www.unicode.org/faq/punctuation_symbols.html#4>
  .remove('#')
  .remove('&')
  .remove('@')
  .remove('%')
  .remove('‰')
  .remove('‱')
  .remove('*')
  .remove('†')
  .remove('‡')
  .remove('※')

const punctuationClosing = regenerate().add(Pe)

const punctuationFinal = regenerate().add(Pf).add('"').add("'")

const whiteSpace = regenerate().add(BPWhiteSpace)

const word = regenerate()
  .add(combiningDiacriticalMark)
  .add(combiningNonspacingMark)
  .add(letter)
  .add(numerical)

const terminalMarker = regenerate()
  .add('.')
  .add(0x20_3d)
  .add('?')
  .add('!')
  .add(0x20_26)

// Symbols part of surrounding words.
const wordSymbolInner = regenerate()
  .add('-')
  .add('@')
  .add('?')
  .add('=')
  .add('.')
  .add(':')
  .add("'")
  .add('&')
  .add(0x20_19) // Right single quote
  .add(0x00_ad) // Soft hyphen
  .add(0x00_b7) // Hyphen
  .add(0x20_10) // Non-breaking hyphen
  .add(0x20_11) // Hyphenation point
  .add(0x20_27) // Middle dot

// Symbols which can occur multiple times and still be part of surrounding
// words.
const wordSymbolInnerMulti = regenerate().add('_')

// Match closing or final punctuation, or terminal markers that should still be
// included in the previous sentence, even though they follow the sentence’s
// terminal marker.
const reAffixSymbol = new RegExp(
  '^(' +
    punctuationClosing +
    '|' +
    punctuationFinal +
    '|' +
    terminalMarker +
    ')\\1*$'
)

// Match one or more new line characters.
const reNewLine = /^[ \t]*((\r?\n|\r)[\t ]*)+$/

// Match sentence-ending markers.
const reTerminalMarker = new RegExp('^((?:' + terminalMarker + ')+)$')

// Match punctuation marks part of surrounding words.
const reWordSymbolInner = new RegExp(
  '^(' +
    '(?:' +
    wordSymbolInner +
    ')' +
    '|' +
    '(?:' +
    wordSymbolInnerMulti +
    ')+' +
    ')$'
)

// Match punctuation marks.
const rePunctuation = new RegExp(String(punctuation))

// Match numbers.
const reNumerical = new RegExp('^(?:' + numerical + ')+$')

// Match initial digit.
const reDigitStart = /^\d/

// Match initial lowercase letter.
const reLowerInitial = new RegExp('^(?:' + letterLower + ')')

// Match anything, when possible words, white spaces, or astrals.
const reSurrogates = /[\uD800-\uDFFF]/

// Match a word.
const reWord = new RegExp(String(word))

// Match white space.
const reWhiteSpace = new RegExp(String(whiteSpace))

fs.writeFileSync(
  path.join('lib', 'expressions.js'),
  [
    '// This module is generated by `script/build-expressions.js`.',
    'export const affixSymbol = ' + reAffixSymbol,
    'export const newLine = ' + reNewLine,
    'export const terminalMarker = ' + reTerminalMarker,
    'export const wordSymbolInner = ' + reWordSymbolInner,
    'export const numerical = ' + reNumerical,
    'export const digitStart = ' + reDigitStart,
    'export const lowerInitial = ' + reLowerInitial,
    'export const surrogates = ' + reSurrogates,
    'export const punctuation = ' + rePunctuation,
    'export const word = ' + reWord,
    'export const whiteSpace = ' + reWhiteSpace,
    ''
  ].join('\n')
)
